<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebRTC test stub</title>
    <script src="http://download.pouchdb.com/pouchdb-nightly.js"></script>
    <script src="pouch.webrtc.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
        a:not([href]):not(.action) { text-decoration: underline; color: lightgrey; }
        a.action { text-decoration: underline; cursor: pointer; }
        .dangerous { color: red; }
        
        #hubStatus { color: grey; }
        #hubStatus.ready { color: green; }
        #hubStatus.error { color: orange; }
    </style>
</head>
<body>

<h1>PeerPouch: PouchDB-over-WebRTC</h1>

<pre>TBD: log to here / simple demo</pre>

<script>
var HUB_URL = "http://peerpouch-test.ipcalf.com",
    SHARE_URL = "idb://peerpouch-test";

queue()
    .defer(PouchDB, HUB_URL)
    .defer(PouchDB, SHARE_URL)
.await(function (e, hub, share) {
    if (e) throw e;
    
    setInterval(function () {
        share.put({_id:'at_'+Date.now()});
    }, 15e3);
    
    // share our local database
    hub.shareDatabase(share, function (e,d) {
        console.log("hub.shareDatabase result", e,d);
    });
    
    // and open whichever other database gets shared next
    var listener = hub.getSharedDatabases({onChange:function (d) {
        console.log("hub.getSharedDatabases change", d);
        listener.cancel();
        
        console.log("Trying to connect to", d._id, d.dbname);
        PouchDB(d.dbname, function (e,remote) {
            if (e) throw e;
            console.log("Opened remote", remote);
            
            remote.info(function (e,d) {
                if (e) throw e;
                remote.allDocs(function (e,d) {
                    console.log("ALL DOCS", e,d);
                });
                remote.changes({since:d.update_seq, continuous:true, onChange:function (change) {
                    console.log("CHANGE", change);
                }});
            });
        });
    }}, function (){/*ignore existing*/});
});

</script>
</body>
</html>